# Feature Specification: Tafawoq - Saudi Aptitude Exam Preparation Platform

**Feature Branch**: `001-saudi-exam-platform`
**Created**: 2025-12-03
**Status**: Draft
**Input**: User description: "Comprehensive React Native AI mobile application for Saudi aptitude exam (القدرات) preparation with full exams, customized practice sessions, subscription tiers, academic track alignment, performance analytics, and progress tracking."

## Clarifications

### Session 2025-12-03

- Q: How should user authentication sessions be managed (token expiration, concurrent sessions, refresh mechanisms)? → A: Use JWT tokens with 7-day expiration and automatic refresh, supporting single active session per device with graceful logout on new login
- Q: What is the question bank size and management approach (static bank vs dynamic generation)? → A: Questions are dynamically generated by AI from resources embedded in the database; AI controls question generation based on section, category, and difficulty requirements
- Q: How should the system handle automated payment failure recovery during subscription renewal? → A: Implement 3 automatic retry attempts with exponential backoff (5s, 30s, 2min), notify user with payment link, 72-hour grace period before downgrade, log failures for manual review
- Q: How should offline exam functionality work with AI-generated questions? → A: Require internet for exam initialization and submission, allow offline answering with local state persistence, auto-sync when reconnected, show clear connectivity status indicator
- Q: What observability and logging strategy should be implemented for production monitoring and debugging? → A: Implement structured logging with error tracking service (Sentry/Bugsnag), capture critical events (auth failures, AI generation errors, payment issues), include user context, log performance metrics for exams/practice, retention: 90 days standard, 1 year for payment/auth

## User Scenarios & Testing *(mandatory)*

### User Story 1 - New User Registration and Profile Setup (Priority: P1)

A new student downloads Tafawoq and creates an account to begin preparing for their aptitude exam. They complete email verification, select their academic track (Scientific or Literary), choose a subscription tier (Free or Premium with 3-day trial), and optionally complete payment if selecting Premium.

**Why this priority**: This is the entry point for all users. Without account creation and onboarding, no other features can be accessed. This establishes the user's identity, academic context, and access level.

**Independent Test**: Can be fully tested by registering a new account through the welcome screen, verifying email, selecting academic track, choosing subscription tier, and confirming successful access to the dashboard. Delivers immediate value by creating a personalized learning profile.

**Acceptance Scenarios**:

1. **Given** a new user opens the app, **When** they tap "Create Account", enter valid email and password, agree to Terms of Service and Privacy Policy, and submit, **Then** they receive a 6-digit OTP verification email and can enter it to verify their account
2. **Given** a user has verified their email, **When** they select their academic track (Scientific or Literary), **Then** their selection is saved and will influence content recommendations throughout the app
3. **Given** a user has selected their academic track, **When** they choose the Free Plan option, **Then** they are directed to the dashboard with limited access (1 exam/week, 5 questions/practice, 2 categories max)
4. **Given** a user has selected their academic track, **When** they choose the Premium Plan option, **Then** they are presented with a Stripe payment form showing "3 days free, then SAR XX.XX/month" with secure card entry
5. **Given** a user enters valid payment information for Premium, **When** the payment processes successfully, **Then** they receive a congratulations screen with their account summary and quick action buttons (profile picture upload, onboarding tour, first practice, dashboard)
6. **Given** a registered user, **When** they access the onboarding tutorial slider, **Then** they see three educational screens explaining: (1) Full Exam vs Customized Practice, (2) Academic Track Optimization, and (3) Performance Tracking System

---

### User Story 2 - Taking a Full Integrated Exam (Priority: P1)

A student wants to assess their overall aptitude level by taking a complete exam that simulates actual test conditions. They launch a full integrated exam covering both Verbal (اللفظي) and Quantitative (كمي) sections, answer questions in both text-only and text-with-image formats, and complete the exam within the standard duration.

**Why this priority**: This is the core value proposition of the app. The full integrated exam provides the authentic assessment experience students need to prepare for their actual aptitude test. Without this feature, the app cannot fulfill its primary purpose.

**Independent Test**: Can be fully tested by initiating a full exam from the dashboard, progressing through both Verbal and Quantitative sections with mixed question formats (text-only and text-with-images), completing the exam, and receiving the three-score result. Delivers immediate value by providing a realistic exam simulation and comprehensive performance assessment.

**Acceptance Scenarios**:

1. **Given** a Free Plan user has taken 0 exams this week, **When** they tap "Start Full Integrated Exam", **Then** the exam begins immediately with both Verbal and Quantitative sections combined
2. **Given** a Free Plan user has taken 1 exam this week, **When** they attempt to start another full exam, **Then** they see an upgrade prompt explaining the weekly limit and Premium benefits
3. **Given** a Premium user, **When** they start a full integrated exam, **Then** the exam begins immediately without any restriction prompts
4. **Given** a user is taking an exam, **When** they encounter a Geometry question, **Then** the question displays with a clear geometric diagram image that supports tap-to-zoom functionality
5. **Given** a user is taking an exam, **When** they encounter a Reading Comprehension question, **Then** they see a full text passage followed by multiple questions referencing that passage
6. **Given** a user is answering questions, **When** they view each question, **Then** they see the question number with section indicator (e.g., "السؤال 12 - اللفظي"), difficulty badge (سهل/متوسط/صعب), and question-specific time recommendations
7. **Given** a user completes all exam questions, **When** they submit the exam, **Then** the system calculates and displays three distinct percentage scores: اللفظي (Verbal), الكمي (Quantitative), and Overall Average (arithmetic mean of both sections)

---

### User Story 3 - Viewing Exam Results and Performance Analytics (Priority: P2)

After completing a full integrated exam, a student reviews their comprehensive results to understand their strengths and weaknesses. They see their three-score breakdown, color-coded performance indicators, top 3 strength categories, top 3 weakness categories (focus areas), personalized improvement advice, and question-level performance breakdown.

**Why this priority**: Results without actionable insights have limited value. This feature transforms raw scores into personalized learning guidance, helping students identify exactly where to focus their preparation efforts. This is essential for the learning feedback loop.

**Independent Test**: Can be fully tested by completing an exam and verifying that the result screen displays all analytics components: three-score visualization with color coding, strength/weakness identification, improvement recommendations, per-question breakdown, and action cards. Delivers value by providing clear direction for improvement.

**Acceptance Scenarios**:

1. **Given** a user has completed a full exam, **When** they view the result screen, **Then** they see three prominently displayed scores: اللفظي percentage, الكمي percentage, and Overall Average percentage with visual progress indicators
2. **Given** a user is viewing exam results, **When** their Overall Average is 90-100%, **Then** the score displays in Muted Gold (#D4AF37) color with "Excellent" designation
3. **Given** a user is viewing exam results, **When** their Overall Average is 75-89%, **Then** the score displays in Saudi Deep Green (#1E5631) with "Good" designation
4. **Given** a user is viewing exam results, **When** their Overall Average is 60-74%, **Then** the score displays in Warm Light Grey (#F9FAFB) with "Average" designation
5. **Given** a user is viewing exam results, **When** their Overall Average is below 60%, **Then** the score displays with a warm tone indicator and "Needs Improvement" designation
6. **Given** a user is viewing exam results, **When** the system analyzes category performance, **Then** they see their top 3 strength categories (performed above personal average) displayed as badges with percentages and encouragement messaging
7. **Given** a user is viewing exam results, **When** the system analyzes category performance, **Then** they see their top 3 weakness categories (performed below personal average) identified as "Focus Areas" with visual differentiation from strengths
8. **Given** a user is viewing exam results, **When** improvement advice is generated, **Then** they see personalized recommendations based on their performance patterns, specific category-focused practice suggestions, and time allocation recommendations for weak categories
9. **Given** a user is viewing exam results, **When** they review question performance breakdown, **Then** they see a summary showing questions attempted, correct, incorrect, skipped, and time analysis (average time per question, total exam duration)
10. **Given** a user is viewing exam results, **When** they see the action cards, **Then** they can tap "Take Another Exam" (Saudi Deep Green button), "Practice Specific Categories" (pre-populated with weak areas), or "Review Question Details"
11. **Given** a Scientific Track user views exam results, **When** recommendations are generated, **Then** the Quantitative section is weighted slightly higher in personalized suggestions while maintaining unbiased overall score calculation
12. **Given** a Literary Track user views exam results, **When** recommendations are generated, **Then** the Verbal section is weighted slightly higher in personalized suggestions while maintaining unbiased overall score calculation

---

### User Story 4 - Taking Customized Practice Sessions (Priority: P2)

A student wants to focus on specific weak areas identified in their exam results. They create a customized practice session by selecting sections (Verbal and/or Quantitative), choosing specific categories within each section, setting difficulty level, specifying question count, and completing a targeted practice session to improve in those areas.

**Why this priority**: Targeted practice is essential for efficient exam preparation. After identifying weaknesses through full exams, students need the ability to drill down on specific skills. This feature provides the personalized learning path that distinguishes effective preparation from generic study.

**Independent Test**: Can be fully tested by configuring a custom practice session (section selection, category selection, difficulty, question count), completing the practice, and viewing the focused analytics. Delivers value by enabling deliberate practice on weak areas and tracking category-specific improvement.

**Acceptance Scenarios**:

1. **Given** a user taps "Create Customized Practice", **When** they see section selection, **Then** they can select القسم اللفظي (Verbal Section), القسم الكمي (Quantitative Section), or both
2. **Given** a user has selected Quantitative Section, **When** they view category options, **Then** they see: العمليات الأساسية (Basic Operations), قسم الهندسة (Geometry), and قسم الأسس والجذور (Roots & Exponents)
3. **Given** a user has selected Verbal Section, **When** they view category options, **Then** they see: التناظر اللفظي (Analogies), إكمال الجمل (Sentence Completion), الخطأ السياقي (Contextual Error), المفردة الشاذة (Odd Word Out), and استيعاب المقروء (Reading Comprehension)
4. **Given** a Free Plan user configures a practice session, **When** they select categories, **Then** they can choose a maximum of 2 categories per session and a maximum of 5 total questions
5. **Given** a Premium user configures a practice session, **When** they select categories, **Then** they can choose unlimited categories and select from 5, 10, 20, 30, or custom up to 100 questions
6. **Given** a user configures a practice session, **When** they select difficulty level, **Then** they can choose Easy (سهل), Medium (متوسط), or Hard (صعب)
7. **Given** a Free Plan user attempts to configure more than 5 questions, **When** they adjust the question count, **Then** they see an upgrade prompt highlighting Premium features with question count flexibility
8. **Given** a user completes a practice session, **When** they view results, **Then** they see a single prominently displayed percentage score for the practice session
9. **Given** a user views practice results, **When** they see category performance, **Then** they get a per-category breakdown showing strengths (well-performed categories) and weaknesses (lower performance categories)
10. **Given** a user views practice results with a score exceeding 85%, **When** improvement advice is generated, **Then** the system recommends increasing difficulty level for continued challenge
11. **Given** a user views practice results with a score below 50%, **When** improvement advice is generated, **Then** the system recommends decreasing difficulty level to build foundational understanding
12. **Given** a user completes a practice session, **When** their practice hours counter updates, **Then** the total user practice hours increments by the session duration (Free Plan users see limited visibility, Premium users see full analytics and trends)
13. **Given** a user views practice history, **When** they review past performance, **Then** practice results do NOT affect their overall user percentages (which are calculated solely from full integrated exams)

---

### User Story 5 - Managing Subscription and Access Levels (Priority: P2)

A student reviews their current subscription tier, understands feature limitations, and decides whether to upgrade from Free to Premium or manage their existing Premium subscription. They view subscription status indicators, understand renewal dates, and access upgrade prompts when attempting to use Premium features.

**Why this priority**: Clear subscription management enables users to make informed decisions about accessing premium features. This is critical for monetization and ensuring users understand the value proposition of upgrading. It also prevents frustration from unexpected feature limitations.

**Independent Test**: Can be fully tested by viewing subscription status on profile page, attempting to use Premium features as a Free user (triggering upgrade prompts), upgrading to Premium via Stripe, and managing subscription settings. Delivers value by providing transparent access control and seamless upgrade paths.

**Acceptance Scenarios**:

1. **Given** a user views their profile page, **When** the page loads, **Then** they see a header badge displaying their current subscription tier (Free Plan or Premium)
2. **Given** a Premium user views their profile, **When** they check subscription details, **Then** they see their subscription renewal date and billing cycle information
3. **Given** a Free Plan user attempts restricted features, **When** they encounter a limitation, **Then** they see an "Upgrade to Premium" prompt explaining the specific feature and Premium benefits
4. **Given** a user is on a 3-day trial, **When** they use the app, **Then** they see a countdown indicator showing "subscription ends in X days" as a reminder
5. **Given** any user accesses settings, **When** they view subscription options, **Then** they see a quick-access upgrade button prominently displayed
6. **Given** a Free Plan user, **When** they view their access summary, **Then** they see: 1 full exam attempt per week, 5 questions maximum per practice, 2 categories maximum per practice, basic profile tracking, standard notifications, delayed result review (24-hour delay for technique explanations), and watermarked result screenshots
7. **Given** a Premium user, **When** they view their access summary, **Then** they see: unlimited full exam attempts, unlimited customized practice sessions, up to 100 questions per practice, instant solving technique access, advanced analytics, academic track-specific optimization, priority support, advanced notification customization, and data export capabilities
8. **Given** a Premium user wants to cancel, **When** they access subscription management, **Then** they can cancel anytime with the cancellation effective at the end of their current billing cycle
9. **Given** a user upgrades to Premium, **When** payment processes successfully, **Then** their access level changes immediately and they receive confirmation of their 3-day trial period with subsequent monthly billing

---

### User Story 6 - Tracking Progress Over Time (Priority: P3)

A student monitors their long-term improvement by accessing a progress dashboard that displays historical performance trends, strength/weakness analysis across multiple exams, practice hours accumulated, and visual indicators of learning progress. They can review past exam scores, identify consistent patterns, and see their preparation journey over time.

**Why this priority**: While not essential for basic functionality, progress tracking provides motivational value and helps students see their improvement trajectory. This encourages continued engagement and validates their study efforts over time.

**Independent Test**: Can be fully tested by taking multiple exams and practice sessions over time, then viewing the progress dashboard to see historical trends, accumulated practice hours, and performance evolution. Delivers value by providing long-term learning insights and motivation through visible progress.

**Acceptance Scenarios**:

1. **Given** a user has taken multiple full exams, **When** they access their profile dashboard, **Then** they see persistent tracking of their last full exam scores (اللفظي, الكمي, Overall Average)
2. **Given** a user accesses general profile analytics, **When** the page loads, **Then** they see historical trends showing how their scores have changed over time with visual graphs
3. **Given** a user reviews performance trends, **When** they compare exam results, **Then** they can identify categories where they've consistently improved or declined
4. **Given** a Premium user views progress analytics, **When** they check practice hours, **Then** they see full tracking of total practice hours with trend analysis over weeks and months
5. **Given** a Free Plan user views progress analytics, **When** they check practice hours, **Then** they see practice hours tracked but with limited visibility (basic count only without detailed trends)
6. **Given** a Premium user wants to export data, **When** they access data export capabilities, **Then** they can download their complete exam history and performance reports
7. **Given** a user views their progress dashboard, **When** performance export reports are generated, **Then** the reports include historical exam scores, category performance breakdowns, and improvement trajectories

---

### User Story 7 - Receiving Notifications and Reminders (Priority: P3)

A student receives timely notifications for exam reminders, learning milestones achieved (e.g., practice hour thresholds, score improvements), and engagement prompts to maintain consistent study habits. Premium users have access to advanced notification customization and scheduling options.

**Why this priority**: Notifications enhance engagement and help students maintain consistent preparation habits, but they are not essential for core functionality. They provide value through timely reminders and celebrating achievements, which supports long-term retention.

**Independent Test**: Can be fully tested by triggering notification events (scheduled exam reminders, milestone achievements) and verifying that notifications are delivered appropriately with correct messaging. Premium users can test advanced customization. Delivers value by maintaining study momentum and recognizing progress.

**Acceptance Scenarios**:

1. **Given** a user has scheduled study time or exam practice, **When** the scheduled time approaches, **Then** they receive a notification reminding them to prepare or start their session
2. **Given** a user reaches a learning milestone (e.g., 10 hours of practice, first perfect score in a category), **When** the milestone is achieved, **Then** they receive a congratulatory notification celebrating their progress
3. **Given** a Free Plan user, **When** they receive notifications, **Then** they get standard notification system with basic exam reminders and milestone notifications
4. **Given** a Premium user, **When** they access notification settings, **Then** they can customize notification frequency, timing, and types with advanced scheduling options
5. **Given** a user has been inactive for several days, **When** the engagement threshold is reached, **Then** they receive an encouragement notification prompting them to continue their preparation

---

### Edge Cases

- What happens when a user attempts to take a full exam but has no internet connection during the exam? The system requires internet connection for exam initialization (AI question generation) and submission. If connection is lost during answering, the user can continue answering questions offline with local state persistence. A connectivity status indicator displays current connection status. When connection is restored, the system automatically syncs progress. If the user attempts to start a new exam without internet, they see a clear message requiring connection for initialization.
- How does the system handle a user who changes their academic track mid-preparation? The system triggers content re-recommendation and adjusts future suggestions based on the new track, but historical exam results remain unchanged.
- What happens if a user's payment fails during subscription renewal? The system automatically attempts 3 retries with exponential backoff (5 seconds, 30 seconds, 2 minutes). The user receives immediate email notification with a payment update link. Their Premium access continues for 72 hours to allow payment resolution. If all retries fail and the grace period expires, the system automatically downgrades to Free Plan and logs the failure for manual support review.
- How does the system handle a Premium user who cancels their subscription but still has days remaining in their billing cycle? The user retains full Premium access until the end of their current billing cycle, then automatically downgrades to Free Plan.
- What happens when a Free Plan user completes their 1 weekly exam on Sunday evening and the week resets? The system resets the weekly exam counter based on calendar week (Monday-Sunday) and the user can take another exam starting Monday.
- How does the system handle questions with images that fail to load? The question displays a skeleton screen with placeholder text and a retry button. If images remain unavailable, the question is skipped and doesn't count toward the user's score.
- What happens when a user tries to verify their email but the OTP has expired (e.g., after 15 minutes)? The user sees an expiration message and can request a new OTP with a 60-second cooldown between requests.
- How does the system handle a user who creates multiple accounts with the same email address? The system prevents duplicate email registrations and prompts the user to sign in to their existing account or reset their password if forgotten.
- What happens when a user attempts to take a practice session with categories that have insufficient embedded resources for AI generation at the selected difficulty level? The system notifies the user to select a different difficulty level or adjust categories, ensuring quality question generation.
- How does the system handle partial exam completion (user exits mid-exam)? For Free Plan users, the incomplete exam counts toward their weekly limit. For Premium users, incomplete exams don't count against any limits. Users can optionally resume incomplete exams from where they left off within a time window (e.g., 24 hours).
- What happens when AI question generation fails or times out during exam/practice initialization? The system retries generation up to 3 times with exponential backoff. If all retries fail, the user sees a friendly error message and can retry later. The failed attempt does not count against subscription limits. The failure is logged with full context for monitoring and debugging.
- How does the system handle personally identifiable information (PII) in logs and monitoring data? The system automatically excludes sensitive data (passwords, tokens, full card numbers) from all logs. User IDs are anonymized using hashing. All logging complies with privacy regulations and the app's Privacy Policy. Logs are stored securely with access controls limited to authorized technical staff.

## Requirements *(mandatory)*

### Functional Requirements

**Registration & Authentication**

- **FR-001**: System MUST allow users to create accounts using a valid email address and password with minimum 8 characters including uppercase, lowercase, number, and symbol
- **FR-002**: System MUST send a 6-digit OTP verification code to the user's email upon account creation and require email verification before granting full access
- **FR-003**: System MUST provide an OTP resend option with a 60-second cooldown period between requests
- **FR-004**: System MUST require users to acknowledge Terms of Service and Privacy Policy via checkboxes during registration
- **FR-005**: System MUST display password strength indicator with visual feedback during password creation
- **FR-006**: System MUST allow users to sign in with verified email and password credentials
- **FR-007**: System MUST provide password reset functionality for users who forget their credentials
- **FR-007a**: System MUST implement JWT-based session management with 7-day token expiration and automatic refresh mechanism to maintain continuous authenticated access
- **FR-007b**: System MUST enforce single active session per device, automatically invalidating previous sessions when user signs in from the same device
- **FR-007c**: System MUST provide graceful logout notification when a new login is detected from the same device, informing users of the session change
- **FR-007d**: System MUST securely store JWT tokens on the client device using platform-specific secure storage (Keychain for iOS, Keystore for Android)

**Academic Track & Profile**

- **FR-008**: System MUST allow users to select one academic track during onboarding: Scientific Track (المسار العلمي) or Literary Track (المسار الأدبي)
- **FR-009**: System MUST use the selected academic track to influence content recommendations, default category ordering, difficulty scaling, and practice suggestions throughout the app
- **FR-010**: System MUST allow users to change their academic track in settings, which triggers content re-recommendation
- **FR-011**: System MUST provide an optional profile picture upload feature accessible after registration
- **FR-012**: System MUST display a three-screen onboarding tutorial slider after registration covering: (1) Full Exam vs Customized Practice, (2) Academic Track Optimization, and (3) Performance Tracking System
- **FR-013**: System MUST allow users to access the onboarding tutorial from Settings → Help at any time

**Subscription Management**

- **FR-014**: System MUST offer two subscription tiers: Free Plan (الخطة المجانية) and Monthly Paid Plan (الخطة الشهرية المدفوعة)
- **FR-015**: System MUST limit Free Plan users to: 1 full exam attempt per week, maximum 5 questions per practice session, maximum 2 categories per practice session, basic profile tracking, standard notifications, 24-hour delayed access to solving technique explanations, and watermarked result screenshots
- **FR-016**: System MUST provide Premium users with: unlimited full exam attempts, unlimited practice sessions, up to 100 questions per practice, instant solving technique access, advanced analytics, academic track-specific optimization, priority support, advanced notification customization, and data export capabilities
- **FR-017**: System MUST integrate with Stripe for secure payment processing with PCI compliance
- **FR-018**: System MUST offer a 3-day free trial for new Premium subscribers with credit card on file
- **FR-019**: System MUST display subscription status on the user's profile page with a header badge indicating current tier (Free or Premium)
- **FR-020**: System MUST show Premium users their subscription renewal date and billing cycle information
- **FR-021**: System MUST display "Upgrade to Premium" prompts when Free Plan users attempt to access restricted features, with feature-specific explanations of Premium benefits
- **FR-022**: System MUST show trial users a countdown indicator displaying remaining trial days
- **FR-023**: System MUST provide a quick-access upgrade button in the settings page
- **FR-024**: System MUST allow Premium users to cancel their subscription anytime, with cancellation effective at the end of the current billing cycle
- **FR-025**: System MUST implement automatic monthly recurring billing for Premium subscriptions on a calendar month basis
- **FR-025a**: System MUST implement automated payment failure recovery with 3 retry attempts using exponential backoff intervals (5 seconds, 30 seconds, 2 minutes) when subscription renewal payment fails
- **FR-025b**: System MUST send immediate email notification to users upon initial payment failure, including secure payment update link to resolve payment issues
- **FR-025c**: System MUST maintain Premium access for 72 hours (grace period) after initial payment failure to allow users time to resolve payment issues
- **FR-025d**: System MUST automatically downgrade users to Free Plan after 72-hour grace period expires if all retry attempts fail and payment remains unresolved
- **FR-025e**: System MUST log all payment failures with retry history, timestamps, and failure reasons for manual customer support review and recovery attempts
- **FR-025f**: System MUST display in-app payment status banner for users in grace period, showing remaining time and payment update action button

**Full Integrated Exams**

- **FR-026**: System MUST provide full integrated exams combining both Verbal (القسم اللفظي) and Quantitative (القسم الكمي) sections in a single exam session
- **FR-027**: System MUST dynamically generate exam questions using AI from embedded resources in the database, producing mixed question formats (text-only and text-with-image) based on section, category, and difficulty requirements
- **FR-027a**: System MUST maintain embedded educational resources in the database that serve as source material for AI question generation, covering all categories and difficulty levels
- **FR-028**: System MUST include geometric diagrams for Geometry questions with responsive sizing, high DPI support, lazy loading, and tap-to-zoom functionality
- **FR-029**: System MUST include full text passages for Reading Comprehension questions with multiple questions referencing each passage
- **FR-030**: System MUST display each question with: question number, section indicator (e.g., "السؤال 12 - اللفظي"), difficulty badge (سهل/متوسط/صعب), and question-specific time recommendations where applicable
- **FR-031**: System MUST show skeleton screens with placeholder text during image loading
- **FR-032**: System MUST provide alt text for all images describing mathematical or technical content for accessibility
- **FR-033**: System MUST enforce Free Plan limit of 1 full exam attempt per week
- **FR-034**: System MUST allow unlimited full exam attempts for Premium users
- **FR-035**: System MUST display an upgrade prompt when Free Plan users exceed their weekly exam limit, explaining Premium benefits
- **FR-036**: System MUST calculate three distinct percentage scores upon exam completion: اللفظي Score (Verbal Section), الكمي Score (Quantitative Section), and Overall Average (arithmetic mean of both sections)
- **FR-037**: System MUST ensure each section is scored independently on a 0-100% scale
- **FR-037a**: System MUST require internet connection for exam initialization to enable AI question generation from embedded resources
- **FR-037b**: System MUST require internet connection for exam submission to sync results to the server
- **FR-037c**: System MUST allow users to continue answering questions offline if internet connection is lost during the exam session
- **FR-037d**: System MUST persist exam state locally (questions, answers, time tracking) using device secure storage during offline periods
- **FR-037e**: System MUST display a clear connectivity status indicator showing current connection state (online/offline) during exam sessions
- **FR-037f**: System MUST automatically synchronize exam progress when internet connection is restored without user intervention
- **FR-037g**: System MUST prevent new exam initialization attempts when no internet connection is available, displaying a clear error message explaining the requirement

**Customized Practice Sessions**

- **FR-038**: System MUST allow users to create customized practice sessions by selecting one or both sections: القسم اللفظي (Verbal) or القسم الكمي (Quantitative)
- **FR-039**: System MUST provide Quantitative Section categories: العمليات الأساسية (Basic Operations), قسم الهندسة (Geometry), and قسم الأسس والجذور (Roots & Exponents)
- **FR-040**: System MUST provide Verbal Section categories: التناظر اللفظي (Analogies), إكمال الجمل (Sentence Completion), الخطأ السياقي (Contextual Error), المفردة الشاذة (Odd Word Out), and استيعاب المقروء (Reading Comprehension)
- **FR-041**: System MUST allow users to select difficulty level: Easy (سهل), Medium (متوسط), or Hard (صعب)
- **FR-042**: System MUST limit Free Plan users to maximum 5 questions per practice session and maximum 2 categories per session
- **FR-043**: System MUST allow Premium users to select 5, 10, 20, 30, or custom question counts up to 100 questions per practice session
- **FR-044**: System MUST allow Premium users to select unlimited categories per practice session
- **FR-045**: System MUST display an upgrade prompt when Free Plan users attempt to configure more than 5 questions or more than 2 categories
- **FR-046**: System MUST use AI to dynamically generate practice session questions from embedded resources based on user selections (sections, categories, difficulty level) with appropriate text-only and text-with-image question inclusion
- **FR-047**: System MUST calculate a single overall percentage score for each completed practice session
- **FR-048**: System MUST increment the user's total practice hours counter with each completed practice session
- **FR-049**: System MUST track practice hours for Free Plan users but provide limited visibility (basic count only)
- **FR-050**: System MUST provide Premium users with full practice hour analytics including trends over time
- **FR-051**: System MUST persist practice history separately from exam results for motivation and engagement metrics
- **FR-052**: System MUST ensure practice results do NOT affect overall user percentages (which are based solely on full integrated exams)
- **FR-052a**: System MUST require internet connection for practice session initialization and submission, with offline answering capability and automatic sync (same offline handling as full exams)

**Result Screens & Analytics**

- **FR-053**: System MUST display full exam results with three section percentages (اللفظي, الكمي, Overall Average) prominently shown with visual progress indicators
- **FR-054**: System MUST apply color coding to exam results: Excellent (90-100%) in Muted Gold (#D4AF37), Good (75-89%) in Saudi Deep Green (#1E5631), Average (60-74%) in Warm Light Grey (#F9FAFB), Needs Improvement (<60%) in warm tone
- **FR-055**: System MUST identify and display top 3 strength categories (performed above personal average) with badge display, percentages, and encouragement messaging
- **FR-056**: System MUST identify and display top 3 weakness categories (performed below personal average) as "Focus Areas" with visual differentiation from strengths
- **FR-057**: System MUST generate personalized improvement advice based on performance patterns, including specific category-focused practice suggestions and time allocation recommendations for weak categories
- **FR-058**: System MUST provide question performance breakdown showing: questions attempted, correct, incorrect, skipped, average time per question, and total exam duration
- **FR-059**: System MUST display action cards on exam result screen: "Take Another Exam" (primary, Saudi Deep Green), "Practice Specific Categories" (secondary, pre-populated with weak areas), and "Review Question Details" (tertiary)
- **FR-060**: System MUST apply track-specific weighting for recommendations: Scientific Track users receive quantitative-weighted suggestions, Literary Track users receive verbal-weighted suggestions (while maintaining unbiased overall score calculation)
- **FR-061**: System MUST display practice session results with single percentage score prominently, selected categories confirmation, strength/weakness breakdown within practice scope, and time metrics
- **FR-062**: System MUST provide category-specific performance breakdown for practice sessions showing strengths (well-performed categories) and weaknesses (lower performance categories)
- **FR-063**: System MUST generate targeted improvement advice for practice sessions including: related full exam sections for comprehensive learning, difficulty increase recommendation if score exceeds 85%, difficulty decrease recommendation if score below 50%
- **FR-064**: System MUST display time metrics for practice sessions: average time per question, and for Premium users, comparison to benchmark time
- **FR-065**: System MUST display action cards on practice result screen: "Take Another Practice" (primary, Saudi Deep Green), "Review Practice Details" (secondary), and "Start Full Exam" (tertiary)
- **FR-066**: System MUST provide Free Plan users with current practice session percentage only
- **FR-067**: System MUST provide Premium users with historical average for same category, trend indicators, and anonymized peer percentile for practice sessions

**Progress Tracking & Dashboard**

- **FR-068**: System MUST display persistent tracking of the user's most recent full exam scores (اللفظي, الكمي, Overall Average) on the profile dashboard
- **FR-069**: System MUST provide general profile analytics showing historical trends and comparisons of exam scores over time
- **FR-070**: System MUST allow Premium users to export performance data including exam history and performance reports
- **FR-071**: System MUST display practice hours with full tracking and trends for Premium users
- **FR-072**: System MUST display limited practice hour visibility (basic count only) for Free Plan users

**Notifications**

- **FR-073**: System MUST send notifications for exam reminders based on user's scheduled study time or exam practice
- **FR-074**: System MUST send notifications when users reach learning milestones (e.g., practice hour thresholds, score improvements)
- **FR-075**: System MUST provide standard notification system for Free Plan users with basic exam reminders and milestone notifications
- **FR-076**: System MUST provide Premium users with advanced notification customization including frequency, timing, types, and scheduling options
- **FR-077**: System MUST send engagement prompts when users have been inactive for an extended period to encourage continued preparation

**Legal Compliance**

- **FR-078**: System MUST provide full text of Terms of Service accessible via embedded link during registration and from app settings
- **FR-079**: System MUST provide full text of Privacy Policy accessible via embedded link during registration and from app settings
- **FR-080**: System MUST require explicit user acknowledgment of Terms of Service and Privacy Policy before allowing account creation

**Observability & Monitoring**

- **FR-081**: System MUST implement centralized error tracking using an error monitoring service (Sentry, Bugsnag, or equivalent) to capture and aggregate application errors and crashes
- **FR-082**: System MUST capture and log critical authentication events including: failed login attempts, JWT token validation failures, session expiration events, and account lockouts
- **FR-083**: System MUST capture and log AI question generation events including: generation requests, success/failure status, generation latency, retry attempts, and final outcomes
- **FR-084**: System MUST capture and log payment processing events including: payment initiation, success/failure status, retry attempts, grace period activations, and subscription status changes
- **FR-085**: System MUST include user context with logged events: user ID (anonymized for privacy), subscription tier, academic track, device type, app version, and timestamp
- **FR-086**: System MUST log performance metrics for exam sessions including: initialization time, question load time, submission time, offline sync duration, and total session duration
- **FR-087**: System MUST log performance metrics for practice sessions including: configuration time, generation time, completion time, and score calculation time
- **FR-088**: System MUST retain standard operational logs for 90 days to support debugging and issue resolution
- **FR-089**: System MUST retain authentication and payment logs for 1 year to support compliance, audit trails, and dispute resolution
- **FR-090**: System MUST implement structured logging with consistent log levels (ERROR, WARN, INFO, DEBUG) and machine-readable formats (JSON) for efficient querying and analysis
- **FR-091**: System MUST exclude sensitive personal information from logs including: passwords, raw JWT tokens, full payment card numbers, and email content
- **FR-092**: System MUST implement alerting for critical failures including: payment processing failures exceeding threshold, AI generation failures exceeding threshold, authentication service downtime, and database connection failures

### Key Entities *(include if feature involves data)*

- **User**: Represents a student using the app. Key attributes include: email address, password (hashed), email verification status, selected academic track (Scientific or Literary), subscription tier (Free or Premium), subscription renewal date, trial status, total practice hours, profile picture (optional), registration date, last login timestamp, active JWT token (hashed), token expiration timestamp, and device identifier for session management.

- **Exam**: Represents a full integrated exam attempt. Key attributes include: exam ID, user ID (relationship to User), exam date/time, Verbal section score (percentage), Quantitative section score (percentage), overall average score (percentage), completion status, time taken, questions attempted/correct/incorrect/skipped, category performance breakdown, sync status (synced/pending), local storage timestamp, and last sync timestamp.

- **Question**: Represents an AI-generated exam or practice question. Key attributes include: question ID, generation timestamp, section type (Verbal or Quantitative), category (e.g., Basic Operations, Analogies, Geometry), difficulty level (Easy, Medium, Hard), question text in Arabic, answer options, correct answer, question format (text-only or text-with-image), image URL (if applicable, generated or retrieved by AI), image alt text (if applicable), time recommendation, source resource IDs (references to embedded resources used for generation), and AI generation metadata (model version, prompt template used).

- **Educational Resource**: Represents embedded source material for AI question generation. Key attributes include: resource ID, content type (text passage, mathematical concept, vocabulary set, geometric principle), section type (Verbal or Quantitative), category association, embedded vector representation, original content in Arabic, difficulty level indicator, metadata tags, creation timestamp, and usage frequency tracking.

- **Practice Session**: Represents a customized practice attempt. Key attributes include: session ID, user ID (relationship to User), session date/time, selected sections (Verbal/Quantitative), selected categories, difficulty level, question count, overall score (percentage), completion status, time taken, category-specific performance breakdown, questions attempted/correct/incorrect/skipped, sync status (synced/pending), local storage timestamp, and last sync timestamp.

- **Subscription**: Represents a user's subscription details. Key attributes include: subscription ID, user ID (relationship to User), tier type (Free or Premium), billing cycle start date, next renewal date, payment status, trial status (active/expired/none), trial end date, Stripe customer ID, payment method details (tokenized), cancellation status, payment retry count, last payment failure timestamp, grace period expiration timestamp, and payment failure log (retry history with timestamps and error codes).

- **Notification**: Represents a notification sent to or scheduled for a user. Key attributes include: notification ID, user ID (relationship to User), notification type (exam reminder, milestone, engagement prompt), message content in Arabic, scheduled delivery time, delivery status (pending/sent/read), and creation timestamp.

- **Progress Tracking**: Represents historical performance data for a user. Key attributes include: tracking ID, user ID (relationship to User), data type (exam scores, practice hours, category performance), time period (week/month), aggregated metrics (average scores, total practice time, improvement trends), and timestamp.

## Success Criteria *(mandatory)*

### Measurable Outcomes

- **SC-001**: Users can complete account registration including email verification, academic track selection, and subscription tier selection in under 5 minutes
- **SC-002**: Users can successfully initiate and complete a full integrated exam with both Verbal and Quantitative sections without technical interruptions
- **SC-003**: Exam results display all three scores (Verbal, Quantitative, Overall Average) with color-coded performance indicators within 2 seconds of exam submission
- **SC-004**: Users receive personalized improvement advice identifying top 3 strengths and top 3 weaknesses immediately after viewing exam results
- **SC-005**: Free Plan users attempting to access Premium features see clear upgrade prompts explaining specific feature benefits and subscription options
- **SC-006**: Premium subscription payment processing via Stripe completes successfully with confirmation shown to users within 10 seconds
- **SC-007**: Users can configure and start a customized practice session (section, categories, difficulty, question count) in under 3 minutes
- **SC-008**: Practice session results display single percentage score with category-specific strength/weakness breakdown within 2 seconds of session completion
- **SC-009**: Question images (for Geometry and other visual questions) load within 3 seconds on standard mobile connections with tap-to-zoom functionality working smoothly
- **SC-010**: Users can access their progress dashboard and view historical exam score trends with visual graphs loading within 5 seconds
- **SC-011**: 90% of new users successfully complete the onboarding tutorial and understand the difference between full exams and customized practice sessions
- **SC-012**: Users receive exam reminder notifications within 1 minute of the scheduled time
- **SC-013**: Premium users can successfully export their complete exam history and performance reports in under 30 seconds
- **SC-014**: Free Plan users are accurately limited to 1 full exam per week, with the weekly counter resetting correctly at the start of each calendar week
- **SC-015**: Scientific Track users see Quantitative-weighted recommendations while Literary Track users see Verbal-weighted recommendations, demonstrating personalized content adaptation
- **SC-016**: Users attempting features beyond their subscription tier encounter appropriate upgrade prompts 100% of the time without access leakage
- **SC-017**: Practice hours accurately increment after each completed session and display correctly in user profiles (full analytics for Premium, basic count for Free)
- **SC-018**: Email OTP verification codes are delivered within 2 minutes of registration with successful resend functionality on 60-second cooldown
- **SC-019**: Users can view Terms of Service and Privacy Policy documents in full from registration screen and settings with clear formatting and Arabic language support
- **SC-020**: System maintains distinction between exam-based overall scores and practice session scores, ensuring practice results do not incorrectly impact user percentages derived from full exams
- **SC-021**: Error tracking service successfully captures and reports application crashes and critical errors with full stack traces and user context within 60 seconds of occurrence
- **SC-022**: AI question generation failures are logged with complete context (section, category, difficulty, retry attempts) enabling root cause analysis within error monitoring dashboard
- **SC-023**: Payment processing events (successes, failures, retries) are logged with sufficient detail to trace transaction lifecycle and troubleshoot payment issues without exposing sensitive card data
- **SC-024**: System logs exclude all sensitive personal information (passwords, tokens, full card numbers) as verified through automated log scanning and manual security review
